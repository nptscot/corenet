---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# corenet

<!-- badges: start -->
[![R-CMD-check](https://github.com/nptscot/corenet/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/nptscot/corenet/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

```{r, eval=FALSE, echo=FALSE}
# Code here used to set-up the package, saved for reference... 
# Check the pkg name is available
remotes::install_cran("available")
available::available("corenet")
# Create the package
usethis::use_description()
# Add package dependencies
usethis::use_package("sf")
usethis::use_package("tibble", type = "Suggests")
usethis::use_build_ignore("README.Rmd")
usethis::use_build_ignore("*.zip")
usethis::use_build_ignore("*.gpkg")
usethis::use_git_ignore("Data")
usethis::use_git_ignore("Doc")
# Add license via usethis (MIT):
usethis::use_mit_license("Zhao Wang")

# Add continuous integration
devtools::check()
usethis::use_github_action()
# Set-up website
usethis::use_pkgdown()
# Use GitHub pages:
usethis::use_github_pages()
# Action to build and push to the website with every commit:
usethis::use_pkgdown_github_pages()
# Create a function:
usethis::use_r("corenet")
# Create example osm_edinburgh_demo data object:
usethis::use_data_raw("osm_edinburgh_demo")

devtools::build_readme()
# Check the package again:
devtools::check()

# # Publish to CRAN (when ready):
# devtools::release()
```

The goal of corenet is to provide a set of functions to generate 'core' route networks for transport planning.

Install it with:

```{r, eval=FALSE}
if (!require("remotes")) {
  install.packages("remotes")
}
remotes::install_github("nptscot/corenet")
```

```{r}
library(osmactive)
library(tmap) 
library(dplyr) 
```

Alternatively, you can load the package with the following for local development:

```{r, include=FALSE}
devtools::load_all()
```

## Minimal example

The package comes with example data for testing functions.
You can test the functions as follows:

```{r}
parameters = jsonlite::read_json("parameters.json", simplifyVector = T)
lads = sf::read_sf("inputdata/la_regions_2023.geojson")
region_names = unique(lads$Region)[c(3, 2, 1, 4, 5, 6)] # Start with Glasgow
cities_region_names = list()

for (region in region_names) {
# Assuming 'CityName' is the column that holds the names of cities or localities
  cities_in_region = lads |> 
    filter(Region == region) |> 
    pull(LAD23NM) |> 
    unique() # Ensure unique city names

# Add the city names to the list under the region name
  cities_region_names[[region]] = cities_in_region
}
```

```{r}
devtools::load_all()
# for (region in region_names[1:6]) {

region = "Edinburgh and Lothians"
message("Processing coherent network for region: ", region)
parameters$region = region
parameters$coherent_area = "City of Edinburgh"

combined_network_tile_path = "inputdata/combined_network_tile.geojson"
combined_network_tile = sf::read_sf(combined_network_tile_path) |> sf::st_transform(crs = crs)

NPT_MM_OSM = cohesive_network_prep(combined_network_tile, crs = "EPSG:27700", parameters = parameters)

NPT_MM_OSM_CITY =  NPT_MM_OSM$cohesive_network

NPT_MM_OSM_ZONE =  NPT_MM_OSM$cohesive_zone

city = "City of Edinburgh"
city_filename = gsub(" ", "_", city)

CITY = NPT_MM_OSM_CITY[[city]]
ZONE = NPT_MM_OSM_ZONE[[city]]

percentile = 85
print(paste0("Processing coherent network for ", city, " at percentile ", percentile))
percentile_factor = percentile / 100
grouped_net = coherent_network_group(CITY, ZONE, percentile_factor)


rnet_coherent = corenet(network_tile = CITY, combined_grid_buffer = ZONE, min_percentile = percentile_factor, base_value = "all_fastest_bicycle_go_dutch")



network_tile_filtered= network_tile_filtered|> sf::st_transform(crs = crs)


